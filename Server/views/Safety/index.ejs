<%- include('../head.ejs')%>
<body>
    <style>
        
    </style>

    <section>
        <table id="html-data-table" border=1px width=100% height=100%>
            <h1>Safety Target</h1>
            <tr>
                <th>KPI</th>
                <th>Year</th>
                <th>Target</th>
                <th>Actual</th>
            </tr>
            <script type="text/javascript" charset="utf-8">

                fetch('http://localhost:5000/data')
                    .then(function (response) {
                        return response.json();
                        //EXCEL DATA FROM API AS JSON;
                    }).then(function (apiJsonData) {
                        renderDataInTheTable(apiJsonData);
                        renderDataAsChart(apiJsonData);
                        renderDataInTheTableAct(apiJsonData);
                    })

                function renderDataInTheTable(todos) {
                    // let plot = document.createElement('section')
                    const mytable = document.getElementById("html-data-table");
                    // console.log(todos);
                    // let tableHead = document.createElement()

                    todos.safetyPlan.forEach(todo => {
                        let newRow = document.createElement("tr");
                        Object.values(todo).forEach((value) => {
                            let cell = document.createElement("td");
                            cell.innerText = value;
                            newRow.appendChild(cell);
                        })
                        mytable.appendChild(newRow);
                    });

                }
                function renderDataAsChart(json) {
                    // console.log(json);
                    let axisData = {
                        x: [],
                        y: [],
                        type: 'bar'
                    };
                    //  console.log(json['trcfr']);
                    Object.keys(json['trcfr'][0]).forEach(key => {
                        axisData['x'].push(key);
                        // console.log('key:',key);
                        axisData.y.push(json['trcfr'][0][key]);
                    })
                    // console.log(axisData);
                    let layout = {
                        title:'TRC FR Trend'
                    }
                    let config = {
                        showLink:true,
                        plotlyServerURL: "https://chart-studio.plotly.com",
                        // displayModeBar:false,
                        responsive:false,
                        displaylogo:false
                    }
                    // axisData['text']=y.map(String);
                axisData['opacity'] = 0.5
                    Plotly.newPlot("myPlot", [axisData],layout,config)

                }


                function renderDataInTheTableAct(todos) {
                    // let plot = document.createElement('section')
                    const mytable = document.getElementById("actionPlan");
                    // console.log(todos);
                    // let tableHead = document.createElement()

                    todos.actionPlan.forEach(todo => {
                        let newRow = document.createElement("tr");
                        Object.values(todo).forEach((value) => {
                            let cell = document.createElement("td");
                            cell.innerText = value;
                            newRow.appendChild(cell);
                        })
                        mytable.appendChild(newRow);
                    });
                }


            </script>
        </table>
    </section>
    <section id="myPlot">
    </section>
    <section>
        <table id="actionPlan" border="1px solid">
            <thead>Action Plan</thead>
            <tr>
                <th>#</th>
                <th>Action Initiated/ Planned</th>
                <th>Resp</th>
                <th>Target Date</th>
                <th>Status</th>
            </tr>
        </table>
    </section>
    <section id="fileupload">
        <form id="upload",enctype="multipart/form-data" method="post">
            <input type="file" id = "filedata" name="Upload file" accept = ".xlsx" required single >
            <br>
            <input type ="submit" value="Upload excel">
        </form>
        <script>
            //Post data from excel format provide authentication needed
            const form = document.getElementById('upload')
            const sendFiles = async() =>{
                const myFiles = document.getElementById('filedata').files 
                const formData = new FormData()
                Object.keys(myFiles).forEach(key=>{
                    formData.append(myFiles.item(key).name,myFiles.item(key))
                })

                const response = await fetch('http://localhost:5000/import_excel', {
                    method:'POST',
                    body:formData,
                }) 
            }
            form.addEventListener('submit',(e)=>{
                e.preventDefault();
                sendFiles();
            })
        </script>
    </section>
</body>

</html>